<html>
<head>
<title>AFD (amg.html)</title>
</head>
<body bgcolor="#F0ECD6">
<h1 align=center><a name="amg">AMG (Automatic Message Generator)</a></h1>
<hr size=3 noshade>
<p>
To send files with the AFD, it must know from which directory and what
file(s) it has to transmit. This information and that about the remote
site is found in the file <a href="dir_config.html">DIR_CONFIG</a>. So all
the AMG does is that when files show up it generates a message for the
<a href="fd.html">fd</a>. The message is written in ASCII and stored
in the directory 'messages'. Below is an example of what might be the
contents of a message:
</p>
<p>
<pre>
   [recipient]
   ftp://donald:secret@hollywood//home/user

   [options]
   archive 3
   lock DOT
</pre>
</p>
<p>
These messages are generated only ones in the message directory with
the job ID as there name. At start the FD reads all these messages into
a cache. When the AMG has created a new job it sends the job ID over
the fifo to the FD which now knows which message it needs to apply.
</p>
<h3><a name="dir_check"><u>Dir Check</u></a></h3>
<p>
This process constantly looks into the directories specified in the
DIR_CONFIG to see if any files arrive. It scans all directories in
that order that they have been specified in the DIR_CONFIG every
5 seconds (DEFAULT_RESCAN_TIME). If the directory is not in the same
file system as the AFD it forks to copy the files to the file
directory of the AFD. This is done, to reduce the time when copying
files, especially when the files are mounted via NFS. When the option
'extract', 'exec',  or 'gts2tiff' is set, the inst_job will fork, since the
conversion time can be very long (at least on some systems). If there
are lots of files in a directory it will only take the first 100
(MAX_COPIED_FILES). So it does not take too long to create a job.
Distribution of files should start as early as possible.
</p>
<p>
If files are found, a directory of the following format is created in
the AFD file directory:
</p>
<pre>
     x_nnnnnnnnnn_llll_jjjj
     |     |       |    |
     |     |       |    +--&gt; Job number.
     |     |       +-------&gt; Counter which is set to zero
     |     |                 after each second. This
     |     |                 ensures that no message can
     |     |                 have the same name in one
     |     |                 second.
     |     +---------------&gt; creation time in seconds
     +---------------------&gt; priority of the job
</pre>
<p>
All files that are found are hard linked into this directory. This
procedure is continued for each recipient that wants the same files.
Every time a new directory has been created and all files are linked
into this directory, a message is send to the message fifo MSG_FIFO.
The message in the fifo has the following format:
</p>
<pre>
   &lt;Priority&gt;&lt;creation time&gt;&lt;unique number&gt;&lt;job ID&gt;
       |            |              |           |
       |            |              |           +-&gt; int            [jjjj]
       |            |              +-------------&gt; unsigned short [llll]
       |            +----------------------------&gt; time_t         [nnnnnnnnnn]
       +-----------------------------------------&gt; char           [x]
</pre>
<p>
These messages are read by the FD which will distribute the files.
</p>
<hr size=3 noshade>
<table width=100%>
<tr>
   <td width=90%><small><address>
   Copyright &copy; 1997 - 2001 by H.Kiehl<br>
   <a href="mailto:Holger.Kiehl@dwd.de?subject=AFD Homepage">Holger.Kiehl@dwd.de</a><br>
   Last updated: 04.06.2001
   </address></small></td>
   <td nowrap><small><img align=middle src="../images/reddot.gif" alt="[red dot]"><a href="contents.html">Index</a></small></td>
   <td nowrap><small><img align=middle src="../images/reddot.gif" alt="[red dot]"><a href="index.html">Home</a></small></td>
   <!-- Insert site specific logo -->
</tr>
</table>
</body>
</html>
